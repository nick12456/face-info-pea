<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Face Recognizer PWA</title>
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#0b0b0c" />
<style>
  body{margin:0;background:#0b0b0c;color:#fff;font-family:sans-serif;text-align:center}
  video,canvas{width:100%;max-width:480px;border-radius:8px;margin-top:10px}
  #controls{margin:10px}
  input,button{padding:8px 12px;margin:4px;border-radius:6px;border:1px solid #444}
  #status{margin-top:10px}
</style>
</head>
<body>
  <h2>Face Recognition Demo</h2>
  <div id="controls">
    <input id="nameInput" placeholder="Enter name" />
    <button onclick="enroll()">Enroll</button>
    <button onclick="verify()">Verify</button>
  </div>
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>
  <div id="status">Loading models…</div>

<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
<script>
const MODEL_URL="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/";
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const statusBox=document.getElementById("status");
let known=JSON.parse(localStorage.getItem("faces-db")||"{}");
const MATCH_THRESHOLD=0.58;

async function startCamera(){
  const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
  video.srcObject=stream; await video.play();
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
}

async function loadModels(){
  await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
  await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
  await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
  await faceapi.nets.ageGenderNet.loadFromUri(MODEL_URL);
  await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
  statusBox.innerText="✅ Models loaded";
}

function dist(a,b){let s=0;for(let i=0;i<a.length;i++){let d=a[i]-b[i];s+=d*d;}return Math.sqrt(s);}

async function captureDescriptor(){
  const opts=new faceapi.TinyFaceDetectorOptions({inputSize:160});
  const det=await faceapi.detectSingleFace(video,opts).withFaceLandmarks().withFaceDescriptor().withAgeAndGender().withFaceExpressions();
  if(!det){statusBox.innerText="No face detected";return null;}
  const d=det.descriptor;
  drawOverlay(det);
  return {descriptor:d, age:det.age, gender:det.gender, expr:det.expressions};
}

function drawOverlay(det){
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const {x,y,width,height}=det.detection.box;
  ctx.strokeStyle="cyan"; ctx.lineWidth=2; ctx.strokeRect(x,y,width,height);
  // top emotion
  const exprs=det.expressions; let best=""; let v=0;
  for(const k in exprs){if(exprs[k]>v){best=k;v=exprs[k];}}
  ctx.fillStyle="black"; ctx.fillRect(x,y-20,120,18);
  ctx.fillStyle="white"; ctx.fillText(best+" "+v.toFixed(2),x+4,y-6);
}

async function enroll(){
  const name=document.getElementById("nameInput").value.trim();
  if(!name){alert("Enter name");return;}
  const res=await captureDescriptor(); if(!res) return;
  if(!known[name]) known[name]=[];
  known[name].push(Array.from(res.descriptor));
  localStorage.setItem("faces-db",JSON.stringify(known));
  statusBox.innerText=`Enrolled ${name} (${known[name].length} samples)`;
}

async function verify(){
  const name=document.getElementById("nameInput").value.trim();
  if(!name||!known[name]){alert("Name not enrolled");return;}
  const res=await captureDescriptor(); if(!res) return;
  const dists=known[name].map(v=>dist(res.descriptor,Float32Array.from(v)));
  const min=Math.min(...dists);
  if(min<MATCH_THRESHOLD){
    statusBox.innerText=`✅ Verified as ${name} | mood:${topEmotion(res.expr)} `;
  }else{
    statusBox.innerText=`❌ Face does not match ${name}`;
  }
}

function topEmotion(exprs){
  let best="";let v=0;
  for(const k in exprs){if(exprs[k]>v){best=k;v=exprs[k];}}
  return best;
}

(async()=>{await startCamera();await loadModels();})();
</script>
</body>
</html>
